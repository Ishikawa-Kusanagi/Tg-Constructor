<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Mini App — Витрина</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 600px; margin: auto; }
        h1 { color: #333; }
        .product { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; border-radius: 6px; }
        button { padding: 5px 10px; margin-top: 5px; cursor: pointer; }
        .cart { margin-top: 20px; border-top: 2px solid #000; padding-top: 10px; }
        ul { padding-left: 20px; }
    </style>
</head>
<body>
    <h1>Витрина товаров</h1>
    <div id="products"></div>

    <div class="cart">
        <h2>Корзина</h2>
        <ul id="cart"></ul>
        <button id="checkout">Отправить заказ</button>
    </div>

    <script>
        // === Telegram Web App SDK ===
        const tg = window.Telegram.WebApp;
        tg.BackButton.show();  // показываем кнопку "назад" в Telegram

        // === Переменные корзины ===
        const productsContainer = document.getElementById('products');
        const cartContainer = document.getElementById('cart');
        let cart = [];

        // === Загрузка товаров с backend ===
        fetch('http://127.0.0.1:8000/products')
            .then(res => res.json())
            .then(data => {
                data.forEach(product => {
                    const div = document.createElement('div');
                    div.className = 'product';
                    div.innerHTML = `
                        <strong>${product.name}</strong> - ${product.price}₽<br>
                        ${product.description}<br>
                        <button onclick="addToCart(${product.id}, '${product.name}', ${product.price})">Добавить в корзину</button>
                    `;
                    productsContainer.appendChild(div);
                });
            });

        // === Функции корзины ===
        function addToCart(id, name, price) {
            const item = cart.find(i => i.id === id);
            if (item) item.quantity++;
            else cart.push({id, name, price, quantity: 1});
            renderCart();
        }

        function renderCart() {
            cartContainer.innerHTML = '';
            cart.forEach(item => {
                const li = document.createElement('li');
                li.textContent = `${item.name} x ${item.quantity} = ${item.price * item.quantity}₽`;
                cartContainer.appendChild(li);
            });
        }

        // === Отправка заказа ===
        document.getElementById('checkout').onclick = () => {
            if (cart.length === 0) {
                alert("Корзина пуста!");
                return;
            }

            // Получаем данные пользователя Telegram, если есть
            let customer_name = "";
            const customer_phone = prompt("Телефон:");
            const customer_address = prompt("Адрес:");

            if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                const user = tg.initDataUnsafe.user;
                customer_name = user.first_name + (user.last_name ? " " + user.last_name : "");
            } else {
                customer_name = prompt("Ваше имя:");
            }

            if (!customer_name || !customer_phone || !customer_address) return;

            const order = {
                id: Date.now(),
                items: cart.map(i => ({product_id: i.id, quantity: i.quantity})),
                customer_name,
                customer_phone,
                customer_address
            };

            fetch('http://127.0.0.1:8000/orders', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(order)
            })
            .then(res => res.json())
            .then(data => {
                alert('Заказ отправлен! ID: ' + data.order_id);
                cart = [];
                renderCart();

                // Закрываем Mini App в Telegram
                if (tg.initDataUnsafe) tg.close();
            })
            .catch(err => {
                alert("Ошибка при отправке заказа!");
                console.error(err);
            });
        };
    </script>
</body>
</html>
